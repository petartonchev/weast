{% extends "base.html" %}
{% block content %}
  <div class="row show-sentiment">
    <div class="col-md-6 pt-4 h-100">
      <div class="row h-100">
        <div class="col-md-6 pt-4 h-150px">
          <div class="card small bg-light  shadow rounded border-0 ">
            <div class="card-body p-2">
              <h1 class="display-6 text-dark align-middle text-center ">{{ stock }}</h1>

            </div>
          </div>

        </div>
        <div class="col-md-6 pt-4 h-150px">
          <div class="card small bg-light  shadow rounded border-0 ">
            <div class="card-body p-2">
              <div id="sentiment-chart"></div>
            </div>
          </div>
        </div>
        <div class="col-md-12 pt-4 h-100-150px tweets">
          <div class="card h-100 small bg-light  shadow rounded border-0">
            {#          <div class="card-header border-0 pt-3 lead text-dark">#}
            {#            Tweets:#}
            {#          </div>#}
            <div class="card-body h-100">
              {% for tweet in tweets|dictsortreversed:"retweets" %}
                <div class="row ">
                  <div class="col-md-6">
                    <p class="lead text-muted">{{ tweet.username|capfirst }}</p>
                  </div>
                  <div class="col-md-6">
                    <p class="text-muted float-right info">Sentiment: {{ tweet.sentiment|floatformat:"2" }}</p>
                  </div>
                  <div class="col-md-12 pb-2">
                    {{ tweet.text }}
                  </div>
                  <div class="col-md-6">
                    <p class="text-muted info mb-0">Retweets: {{ tweet.retweets }}</p>
                  </div>
                  <div class="col-md-6 pb-1">
                    <p class="text-muted float-right info mb-0">{{ tweet.created_at|date:"d, M, Y P" }}</p>
                  </div>
                  <div class="col-md-12 mb-4 divider border-bottom"></div>
                </div>
              {% endfor %}
            </div>
          </div>

        </div>
      </div>
    </div>
    <div class="col-md-6 pt-4 charts float-right ">
      <div class="row h-100">
        <div class="col-md-12 h-50 pt-4">
          <div class="card h-100 small bg-light  shadow rounded border-0 ">
            <div class="card-body h-100">
              <div id="trend-chart" class="h-100"></div>
            </div>
          </div>
        </div>
        <div class="col-md-12 h-50 pt-4">
          <div class="card small h-100 bg-light  shadow rounded border-0 ">
            <div class="card-body h-100">
              <div id="perc-change-chart" class="h-100"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>


    document.onreadystatechange = function () {
      if (document.readyState == "interactive") {
        // Initialize application.
        let stocks = new Stocks('N6VYEDBTYS8L175P');

        async function fetchPriceData() {

          let today = new Date();
          const data = await stocks.timeSeries({
            symbol: '{{ stock.ticker }}',
            interval: 'daily',
            start: new Date(today.setMonth(today.getMonth() - 1)),
            end: new Date()
          });

          data.sort((a, b) => (a.date > b.date) ? 1 : -1);
          return data.map(function (day) {
            return [day.date.getTime(), day.close]
          })
        }

        let sentiment_data = {{ sentiment_trend }};
        let sentiment_lookup = {};
        let i;
        for (i = 0; i < sentiment_data.length; i++) {
          let date, sentiment;
          [date, sentiment] = sentiment_data[i];
          date = new Date(date);
          // Set hours to the close time of the stock market
          date.setHours(6, 0, 0, 0);
          // Convert back to timestamp
          date = date.getTime();
          sentiment_lookup[date] = sentiment;
        };


        fetchPriceData().then(function (price_data) {

          let perc_change = [];
          let i;
          for (i = 1; i < price_data.length; i++) {
            let curr_date, curr_price;
            [curr_date, curr_price] = price_data[i];

            let date = new Date(curr_date);
            let price_yesterday = price_data[i - 1][1];

            let curr_perc_change = (curr_price - price_yesterday) / price_yesterday * 100
            perc_change.push({
              x: curr_date,
              y: curr_perc_change,
              sentiment: sentiment_lookup[curr_date]})
          }

          console.log(perc_change)

          Highcharts.chart('trend-chart', {
            chart: {
              zoomType: 'x',
              backgroundColor: 'transparent'
            },
            title: {
              text: 'Real Stock Price vs Sentiment over Time'
            },
            subtitle: {
              text: document.ontouchstart === undefined ?
                'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
            },
            xAxis: {
              type: 'datetime'
            },
            yAxis: [{ // Primary yAxis
              labels: {
                format: '{value}$',
                style: {
                  color: Highcharts.getOptions().colors[0]
                }
              },
              title: {
                text: 'Adj Close',
                style: {
                  color: Highcharts.getOptions().colors[0]
                }
              }
            }, { // Secondary yAxis
              max: 1,
              min: -1,
              endOnTick: false,
              title: {
                text: 'Sentiment',
                style: {
                  color: '#4c9d49'
                }
              },
              labels: {
                style: {
                  color: '#4c9d49'
                }
              },
              opposite: true
            }],
            legend: {
              enabled: false
            },
            plotOptions: {
              area: {
                fillColor: {
                  linearGradient: {
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: 1
                  },
                  stops: [
                    [0, Highcharts.getOptions().colors[0]],
                    [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                  ]
                },
                marker: {
                  radius: 2
                },
                lineWidth: 1,
                states: {
                  hover: {
                    lineWidth: 1
                  }
                },
                threshold: null
              },
              column: {

                opacity: 0.7,
                zones: [{
                  value: 0,
                  color: '#f60239'
                }, {
                  color: '#4c9d49'
                }]
              }
            },

            series: [{
              type: 'area',
              name: 'Adj Close',
              data: price_data
            }, {
              type: 'column',
              name: 'Twitter Sentiment',
              yAxis: 1,
              data: {{ sentiment_trend }}
            }]
          });
          Highcharts.chart('perc-change-chart', {
            chart: {
              zoomType: 'x',
              backgroundColor: 'transparent'
            },
            colorAxis: {
              min: -1,
              max: 1,
              dataClasses: [{
                from: -1,
                to: 0,
                color: '#f60239'
              }, {
                from: 0,
                to: 1,
                color: '#4c9d49'
              }]
            },
            title: {
              text: 'Percentage Change in Stock Price vs Sentiment over Time'
            },
            subtitle: {
              text: document.ontouchstart === undefined ?
                'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
            },
            xAxis: {
              type: 'datetime'
            },
            yAxis: [{ // Primary yAxis
              labels: {
                format: '{value}%',
                style: {
                  color: Highcharts.getOptions().colors[0]
                }
              },
              title: {
                text: 'Percentage Change',
                style: {
                  color: Highcharts.getOptions().colors[0]
                }
              }
            }],
            legend: {
              enabled: false
            },
            plotOptions: {
              column: {
                opacity: 0.7
              }
            },

            series: [{
              type: 'column',
              name: 'Percentage Change',
              data: perc_change,
              colorKey: 'sentiment',
              color: 'grey',
            }],
            tooltip: {
              pointFormat: '<b>Sentiment: {point.sentiment}</b><br><b>Percentage Change: {point.y}%</b>',
              valueDecimals: 2
            }
          });
          Highcharts.setOptions({
            chart: {
              inverted: true,
              marginLeft: 8,
              type: 'bullet',
              backgroundColor: 'transparent'
            },
            title: {
              text: null
            },
            legend: {
              enabled: false
            },
            yAxis: {
              min: -1,
              max: 1,
              endOnTick: false,
              gridLineWidth: 0
            },
            plotOptions: {
              series: {
                pointPadding: 0.35,
                borderWidth: 0,
                color: '#252525',
                targetOptions: {
                  width: '200%'
                }
              }
            },
            credits: {
              enabled: false
            },
            exporting: {
              enabled: false
            }
          });
          Highcharts.chart('sentiment-chart', {
            chart: {
              marginTop: 40
            },
            title: {
              text: 'Overall Sentiment'
            },
            xAxis: {
              categories: [null]
            },
            yAxis: {
              min: -1,
              max: 1,
              endOnTick: false,
              plotBands: [{
                from: -1,
                to: -0.15,
                color: '#f60239'
              }, {
                from: -0.15,
                to: 0.15,
                color: '#999'
              }, {
                from: 0.15,
                to: 1,
                color: '#4c9d49'
              }],
              title: null
            },
            series: [{
              data: [{
                y: {{ sentiment }},
                target: {{ sentiment }}
              }]
            }],
            tooltip: {
              pointFormat: '<b>Sentiment: {point.y}</b>',
              valueDecimals: 2
            }
          });

        });
      }
    }

  </script>
{% endblock content %}
